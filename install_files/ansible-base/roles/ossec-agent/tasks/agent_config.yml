---
- name: Install securedrop-ossec-agent package.
  apt:
    name: securedrop-ossec-agent
    state: present
  when: not install_local_packages
  tags:
    - apt

- name: Add firewall exemption for OSSEC agent registration (both servers)
  iptables:
    chain: "{{ item[0].chain }}"
    destination: "{{ item[0].dest|default(omit) }}"
    destination_port: "{{ item[0].dest_port|default(omit) }}"
    protocol: "{{ item[0].proto }}"
    ctstate: "{{ item[0].cstate }}"
    jump: "{{ item[0].jump }}"
    match: "{{ item[0].match }}"
    source: "{{ item[0].source|default(omit) }}"
    source_port: "{{ item[0].source_port|default(omit) }}"
    state: present
  delegate_to: "{{ item[1] }}"
  with_nested:
    - "{{ authd_iprules }}"
    - "{{ groups['all'] }}"
  when: not ossec_agent_already_registered
  tags:
    - iptables
    - ossec_auth

- debug: var="{{ groups['securedrop_monitor_server'] + groups['securedrop_application_server'] }}"

- name: Register OSSEC agent.
  command: /var/ossec/bin/agent-auth -m {{ monitor_ip }} -p 1515 -A {{ app_hostname }}
  when: not ossec_agent_already_registered
  tags:
    - ossec_auth

  # If the OSSEC agent auth iptable rule exemptions are in place remove them and
  # restart OSSEC. This order does matter. The app server's
  # ossec agent needs to restart to load the imported cert from authd and
  # connect to the ossec server. The monitor server's OSSEC server needs to
  # restart after the agent connects to correctly display the agent status.
- name: Remove firewall exemption for OSSEC agent registration.
  iptables:
    chain: "{{ item[0].chain }}"
    destination: "{{ item[0].dest|default(omit) }}"
    destination_port: "{{ item[0].dest_port|default(omit) }}"
    protocol: "{{ item[0].proto }}"
    ctstate: "{{ item[0].cstate }}"
    jump: "{{ item[0].jump }}"
    match: "{{ item[0].match }}"
    source: "{{ item[0].source|default(omit) }}"
    source_port: "{{ item[0].source_port|default(omit) }}"
    state: present
  delegate_to: "{{ item[1] }}"
  with_nested:
    - "{{ authd_iprules }}"
    - "{{ groups['securedrop_monitor_server'] + groups['securedrop_application_server'] }}"
  when: not ossec_agent_already_registered
  notify: restart ossec
  tags:
    - iptables
    - ossec_auth
